<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SolarCast AI | Official Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .modal-bg { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen font-sans p-4 md:p-8">

    <div class="max-w-5xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 gap-6">
            <div class="text-center md:text-left">
                <div class="flex items-center gap-3 justify-center md:justify-start">
                    <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-yellow-300 italic">SolarCast AI</h1>
                    <button onclick="toggleModal()" class="text-slate-500 hover:text-orange-400 transition-colors focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                </div>
                <p class="text-slate-400 mt-2 font-medium tracking-tight">Real-Time Solar Flux Forecasting</p>
            </div>

            <div class="flex bg-slate-800 p-2 rounded-2xl border border-slate-700 w-full md:w-auto shadow-2xl transition-all focus-within:border-orange-500">
                <input id="pincodeInput" type="number" placeholder="Enter PIN" class="bg-transparent px-6 py-3 outline-none w-full md:w-48 text-xl font-bold tracking-[0.2em] text-orange-400 placeholder:text-slate-600 placeholder:tracking-normal placeholder:text-sm">
                <button onclick="fetchAllData()" class="bg-orange-500 hover:bg-orange-600 px-8 py-3 rounded-xl font-bold transition shadow-lg active:scale-95">Analyze</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 glass-card p-10 rounded-[2.5rem] text-center shadow-2xl relative overflow-hidden">
                <div id="city-display" class="text-orange-400 text-2xl font-black uppercase tracking-tighter mb-2 italic min-h-[2rem]">--</div>
                <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-6">Current Forecast</h3>
                
                <div class="py-4">
                    <span id="ghi-val" class="text-8xl font-black text-white">0</span>
                    <span class="block text-slate-400 font-bold mt-2 text-xl tracking-tight">Watts / m²</span>
                </div>
                
                <div id="status-badge" class="mt-8 py-2 px-6 rounded-full bg-slate-900/50 text-slate-400 text-xs inline-block border border-slate-700">System Ready</div>
                
                <div class="mt-10 pt-10 border-t border-slate-700/30 grid grid-cols-2 gap-4 text-left">
                    <div>
                        <p class="text-slate-500 text-[10px] uppercase font-bold mb-1 tracking-tighter">Temperature</p>
                        <p id="m-temp" class="text-white text-lg font-bold">--</p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-[10px] uppercase font-bold mb-1 tracking-tighter">Status</p>
                        <p id="m-sky" class="text-white text-lg font-bold">--</p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 glass-card p-10 rounded-[2.5rem] shadow-2xl">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-slate-500 text-xs font-bold uppercase tracking-widest">15-Day Peak Potential</h3>
                    <span id="m-coords" class="text-[10px] text-slate-600 font-mono tracking-tighter"></span>
                </div>
                <div class="h-64"><canvas id="forecastChart"></canvas></div>
            </div>
        </div>

        <div id="infoModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
            <div class="modal-bg absolute inset-0" onclick="toggleModal()"></div>
            <div class="relative glass-card max-w-2xl w-full p-8 rounded-[2rem] shadow-2xl border border-orange-500/30 overflow-y-auto max-h-[90vh]">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-3xl font-black text-orange-400 italic uppercase">System Intelligence</h2>
                    <button onclick="toggleModal()" class="text-slate-500 hover:text-white text-2xl">&times;</button>
                </div>

                <div class="space-y-6 text-slate-300">
                    <section>
                        <h4 class="text-white font-bold mb-2">1. The Core Model (XGBoost)</h4>
                        <p class="text-sm">The forecast is powered by an <strong>XGBoost Regressor</strong>, using the native C++ DMatrix engine for maximum performance. It interprets real-time weather parameters to predict irradiance flux.</p>
                    </section>

                    <section>
                        <h4 class="text-white font-bold mb-2">2. Solar Physics (PVLib)</h4>
                        <p class="text-sm">The <strong>Ineichen Clearsky Model</strong> provides a theoretical baseline. By calculating the Solar Zenith Angle and Extraterrestrial Radiation, the system knows exactly where the sun is relative to your Pincode.</p>
                    </section>
                    

                    <section>
                        <h4 class="text-white font-bold mb-2">3. Temporal Encoding</h4>
                        <p class="text-sm">Time is processed using <strong>Cyclical Encoding ($sin$/$cos$ transforms)</strong>. This allows the model to understand the 24-hour solar cycle as a continuous loop rather than a linear number.</p>
                    </section>

                    <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700 text-[10px] font-mono">
                        <p class="text-orange-500 mb-1 tracking-widest uppercase">// Physics Engine Metric</p>
                        <p>Total GHI = Beam + Diffuse + Ground-Reflected</p>
                        <p>Inference Latency: &lt; 50ms</p>
                    </div>
                </div>
                
                <button onclick="toggleModal()" class="w-full mt-8 bg-orange-500/10 hover:bg-orange-500/20 text-orange-500 border border-orange-500/50 py-3 rounded-xl font-bold transition">Close Intelligence Panel</button>
            </div>
        </div>

        <footer class="mt-16 text-center">
            <p class="text-slate-700 text-[10px] uppercase tracking-[0.5em] font-bold">
                XGBoost Native • PVLib • OpenStreetMap
            </p>
        </footer>
    </div>

    <script>
        let myChart;

        function toggleModal() {
            const modal = document.getElementById('infoModal');
            modal.classList.toggle('hidden');
        }

        async function fetchAllData() {
            const pin = document.getElementById('pincodeInput').value;
            const badge = document.getElementById('status-badge');
            const cityDiv = document.getElementById('city-display');

            if (pin.length !== 6) {
                alert("Please enter a valid 6-digit Pincode.");
                return;
            }

            badge.innerText = "Analyzing Atmos Layers...";
            badge.classList.remove('text-red-400', 'text-emerald-400');
            badge.classList.add('animate-pulse', 'text-slate-400');

            try {
                // 1. Prediction Request
                const predRes = await fetch('http://127.0.0.1:8080/predict', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ pincode: pin })
                });
                
                const data = await predRes.json();
                if (!predRes.ok) throw new Error(data.detail || "Request Failed");

                // 2. Update Prediction UI
                cityDiv.innerText = data.city || "Unknown Area";
                document.getElementById('ghi-val').innerText = data.prediction;
                document.getElementById('m-temp').innerText = `${data.metadata.temp}°C`;
                document.getElementById('m-sky').innerText = data.metadata.condition;
                document.getElementById('m-coords').innerText = `COORD_LINK: ${data.lat.toFixed(3)}, ${data.lon.toFixed(3)}`;

                // 3. Outlook Request
                const outlookRes = await fetch(`http://127.0.0.1:8080/outlook?lat=${data.lat}&lon=${data.lon}`);
                const outlookData = await outlookRes.json();
                renderChart(outlookData);

                badge.innerText = "Location Synced";
                badge.classList.remove('animate-pulse', 'text-slate-400');
                badge.classList.add('text-emerald-400');

            } catch (err) {
                console.error("Dashboard Error:", err);
                badge.innerText = "Error: " + err.message;
                badge.classList.remove('animate-pulse', 'text-slate-400');
                badge.classList.add('text-red-400');
                cityDiv.innerText = "--";
            }
        }

        function renderChart(data) {
            const ctx = document.getElementById('forecastChart').getContext('2d');
            if (myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.day),
                    datasets: [{
                        label: 'Peak GHI',
                        data: data.map(d => d.max_potential),
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 4,
                        pointBackgroundColor: '#f97316'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { color: 'rgba(255,255,255,0.05)' }, 
                            ticks: { color: '#64748b', font: { size: 10 } } 
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#64748b', font: { size: 10 } } 
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>